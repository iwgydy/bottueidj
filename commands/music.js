/***************************************************
 * commands/music.js
 * ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /‡πÄ‡∏û‡∏•‡∏á ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏à‡∏≤‡∏Å YouTube
 ***************************************************/
const yts = require('yt-search');
const ytdl = require('@distube/ytdl-core');
const fs = require('fs-extra');
const path = require('path');

module.exports = (bot) => {
  // ----------------------------------------------------------------
  // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: /‡πÄ‡∏û‡∏•‡∏á <‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á>
  // ----------------------------------------------------------------
  bot.onText(/\/‡πÄ‡∏û‡∏•‡∏á (.+)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const songName = match[1].trim();  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á /‡πÄ‡∏û‡∏•‡∏á

    if (!songName) {
      return bot.sendMessage(chatId, "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô /‡πÄ‡∏û‡∏•‡∏á ‡πÉ‡∏à‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤");
    }

    // ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    let searchingMsg;
    try {
      searchingMsg = await bot.sendMessage(chatId, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á: "${songName}" ...`);
    } catch (error) {
      console.error("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", error);
    }

    try {
      // 1) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏ö‡∏ô YouTube
      const searchResults = await yts(songName);
      if (!searchResults.videos || searchResults.videos.length === 0) {
        return bot.sendMessage(chatId, "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
      }

      // 2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏£‡∏Å
      const video = searchResults.videos[0];
      const videoUrl = video.url;
      const videoTitle = video.title;
      const videoAuthor = video.author.name;

      // 3) ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      const cacheDir = path.join(__dirname, '..', 'cache');
      if (!fs.existsSync(cacheDir)) {
        fs.mkdirSync(cacheDir);
      }

      // 4) ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
      const fileName = `music-${Date.now()}.mp3`;
      const filePath = path.join(cacheDir, fileName);

      // 5) ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (audio only)
      const stream = ytdl(videoUrl, { filter: 'audioonly' });
      const writeStream = fs.createWriteStream(filePath);
      stream.pipe(writeStream);

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      stream.on('end', async () => {
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á" (‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ)
        if (searchingMsg) {
          try {
            await bot.deleteMessage(chatId, searchingMsg.message_id);
          } catch (err) {
            // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
          }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (Telegram ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ~50MB)
        const fileSize = fs.statSync(filePath).size;
        if (fileSize > 50 * 1024 * 1024) {
          fs.unlinkSync(filePath);
          return bot.sendMessage(chatId, "‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ");
        }

        // ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå MP3 ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const caption = `üéµ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á: ${videoTitle}\nüë§ ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô: ${videoAuthor}`;
        bot.sendAudio(chatId, filePath, {}, { caption })
          .then(() => {
            // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
            fs.unlinkSync(filePath);
          })
          .catch(err => {
            console.error("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå:", err);
            fs.unlinkSync(filePath);
            bot.sendMessage(chatId, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏•‡∏á");
          });
      });

      // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
      stream.on('error', (error) => {
        console.error("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        bot.sendMessage(chatId, "‚ùó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á");
        if (fs.existsSync(filePath)) fs.unlinkSync(filePath);
      });

    } catch (error) {
      console.error("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
      bot.sendMessage(chatId, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏•‡∏á");
    }
  });

  // ----------------------------------------------------------------
  // ‡∏´‡∏≤‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå /‡πÄ‡∏û‡∏•‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á
  // ----------------------------------------------------------------
  bot.onText(/\/‡πÄ‡∏û‡∏•‡∏á$/, (msg) => {
    bot.sendMessage(msg.chat.id, "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô /‡πÄ‡∏û‡∏•‡∏á ‡πÉ‡∏à‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤");
  });
};
