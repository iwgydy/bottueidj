/***********************************************
 * index.js
 * р╣Др╕Яр╕ер╣Мр╕лр╕ер╕▒р╕Бр╕Вр╕нр╕Зр╕Ър╕нр╕Ч - р╣Вр╕Др╣Йр╕Фр╣Ар╕Йр╕Юр╕▓р╕░р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Ър╕нр╕Ч
 ***********************************************/

const fs = require('fs');
const path = require('path');
const TelegramBot = require('node-telegram-bot-api');

// 1) р╣Гр╕кр╣И Token р╕Вр╕нр╕Зр╕Ър╕нр╕Ч Telegram (р╣Вр╕Ыр╕гр╕Фр╣Ар╕Бр╣Зр╕Ъ Token р╣Др╕зр╣Йр╣Ар╕Ыр╣Зр╕Щр╕Др╕зр╕▓р╕бр╕ер╕▒р╕Ъ ЁЯФТ)
const token = '7929038707:AAHZk78OcCN0Kdjs6mjAIV9DM0Qh-7iEHhs'; // р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Фр╣Йр╕зр╕в Token р╕Ир╕гр╕┤р╕Зр╕Вр╕нр╕Зр╕Др╕╕р╕У

// 2) р╕кр╕гр╣Йр╕▓р╕З instance р╕Вр╕нр╕Зр╕Ър╕нр╕Ч (р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ polling р╣Гр╕лр╣Йр╕Ър╕нр╕Чр╕Яр╕▒р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б)
const bot = new TelegramBot(token, { polling: true });

// р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕г polling
bot.on('polling_error', (err) => console.error('тЪая╕П р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕г polling р╕Вр╕нр╕З Telegram:', err));

console.log("ЁЯдЦ р╕Ър╕нр╕Чр╕Бр╕│р╕ер╕▒р╕Зр╕Чр╕│р╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣И...");

// 3) р╕кр╕гр╣Йр╕▓р╕З Collection р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Бр╣Зр╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З
bot.commands = new Map();

// 4) р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣Мр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Ир╕▓р╕Бр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М commands
const commandsPath = path.join(__dirname, 'commands');
fs.readdirSync(commandsPath).forEach((file) => {
  if (file.endsWith('.js')) {
    // р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╣Вр╕бр╕Фр╕╣р╕ер╕Др╕│р╕кр╕▒р╣Ир╕З
    const command = require(path.join(commandsPath, file));
    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Др╕Яр╕ер╣Мр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕бр╕╡р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
    if (command.name && typeof command.execute === 'function') {
      bot.commands.set(`/${command.name}`, command.description || 'р╣Др╕бр╣Ир╕бр╕╡р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в');
      // р╕кр╣Ир╕З instance р╕Вр╕нр╕Зр╕Ър╕нр╕Чр╣Др╕Ыр╕вр╕▒р╕Зр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕лр╕▓р╕Бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
      if (typeof command.register === 'function') {
        command.register(bot);
      } else {
        command.execute(bot);
      }
      console.log(`тЬЕ р╣Вр╕лр╕ер╕Фр╕Др╕│р╕кр╕▒р╣Ир╕З: /${command.name}`);
    } else {
      console.warn(`тЪая╕П р╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Гр╕Щр╣Др╕Яр╕ер╣М ${file} р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕З`);
    }
  }
});

// 5) р╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Ар╕бр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕Др╕│р╕кр╕▒р╣Ир╕З
bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text || "";

  // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Ар╕Ыр╣Зр╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
  if (text.startsWith('/')) {
    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕▒р╣Йр╕Щр╕бр╕╡р╕Бр╕▓р╕гр╕Бр╕│р╕лр╕Щр╕Фр╣Др╕зр╣Йр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    const command = text.split(' ')[0];
    if (!bot.commands.has(command)) {
      // р╕лр╕▓р╕Бр╣Др╕бр╣Ир╕бр╕╡р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Фр╕▒р╕Зр╕Бр╕ер╣Ир╕▓р╕з р╣Гр╕лр╣Йр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Щр╕╡р╣Й
      bot.sendMessage(chatId, "тЭЧя╕П р╕Бр╕гр╕╕р╕Ур╕▓р╕Юр╕┤р╕бр╕Юр╣Мр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╕лр╕гр╕╖р╕нр╕Юр╕┤р╕бр╕Юр╣М /р╕Фр╕╣р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф ЁЯУЬ р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕╡р╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╣Др╕Фр╣Й");
    }
  } else {
    // р╕лр╕▓р╕Бр╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕Др╕│р╕кр╕▒р╣Ир╕З р╣Гр╕лр╣Йр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕▒р╣Ир╕зр╣Др╕Ы р╕лр╕гр╕╖р╕нр╕Ыр╕ер╣Ир╕нр╕вр╕зр╣Ир╕▓р╕Зр╣Др╕зр╣Й
    // р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Щр╕╡р╣Йр╕Ир╕░р╣Др╕бр╣Ир╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕Др╕│р╕кр╕▒р╣Ир╕З
  }
});
